---
title: flask数据库flask-SQLAlchemy
tags: 数据库开发
categories: ''
---

## 一. SQLAlchemy介绍

SQLAlchemy是Python中最有名的ORM工具。

数据库db查看工具SQLiteSpy：https://www.yunqa.de/delphi/products/sqlitespy/index

关于ORM：

全称Object Relational Mapping（对象关系映射）。

特点是操纵Python对象而不是SQL查询，也就是在代码层面考虑的是对象，而不是SQL，体现的是一种程序化思维，这样使得Python程序更加简洁易读。

具体的实现方式是将数据库表转换为Python类，其中数据列作为属性，数据库操作作为方法。

优点：

- 简洁易读：将数据表抽象为对象（数据模型），更直观易读
- 可移植：封装了多种数据库引擎，面对多个数据库，操作基本一致，代码易维护
- 更安全：有效避免SQL注入

为什么要用sqlalchemy?

虽然性能稍稍不及原生SQL，但是操作数据库真的很方便！

## **二. 使用**

概念和数据类型

概念

| 概念    | 对应数据库   | 说明                 |
| :------ | :----------- | :------------------- |
| Engine  | 连接         | 驱动引擎             |
| Session | 连接池，事务 | 由此开始查询         |
| Model   | 表           | 类定义               |
| Column  | 列           |                      |
| Query   | 若干行       | 可以链式添加多个条件 |

常见数据类型

| 数据类型 | 数据库数据类型 | python数据类型    | 说明                   |
| :------- | :------------- | :---------------- | :--------------------- |
| Integer  | int            | int               | 整形，32位             |
| String   | varchar        | string            | 字符串                 |
| Text     | text           | string            | 长字符串               |
| Float    | float          | float             | 浮点型                 |
| Boolean  | tinyint        | bool              | True / False           |
| Date     | date           | datetime.date     | 存储时间年月日         |
| DateTime | datetime       | datetime.datetime | 存储年月日时分秒毫秒等 |
| Time     | time           | datetime.datetime | 存储时分秒             |

创建数据库表

### 1.安装

```python
pip install SQLalchemy
```

### 2.创建连接

```python
from sqlalchemy import create_engine
engine = create_engine("mysql://user:password@hostname/dbname?charset=uft8")
```

这行代码初始化创建了Engine，Engine内部维护了一个Pool（连接池）和Dialect（方言），方言来识别具体连接数据库种类。

![image-20200919134903113](C:\Users\zheng\AppData\Roaming\Typora\typora-user-images\image-20200919134903113.png)

创建好了Engine的同时，Pool和Dialect也已经创建好了，但是此时并没有真正与数据库连接，等到执行具体的语句.connect()等时才会连接到数据库。

```python
engine = create_engine("mysql://user:password@hostname/dbname?charset=uft8",
            echo=True,
            pool_size=8,
            pool_recycle=60*30
            )
```

- echo: 当设置为True时会将orm语句转化为sql语句打印，一般debug的时候可用
- pool_size: 连接池的大小，默认为5个，设置为0时表示连接无限制
- pool_recycle: 设置时间以限制数据库多久没连接自动断开

### **3. 创建数据库表类（模型）**

前面有提到ORM的重要特点，那么我们操作表的时候就需要通过操作对象来实现，现在我们来创建一个类，以常见的用户表举例：

```python
from sqlalchemy.ext.declarative import declarative_base
Base = declarative_base()
class Users(Base):
  __tablename__ = "users"
  id = Column(Integer, primary_key=True)
  name = Column(String(64), unique=True)
  email = Column(String(64))
  def __init__(self, name, email):
       self.name = name
       self.email = email
```

declarative_base()是sqlalchemy内部封装的一个方法，通过其构造一个基类，这个基类和它的子类，可以将Python类和数据库表关联映射起来。

数据库表模型类通过__tablename__和表关联起来，Column表示数据表的列。

### 4.数据库与pandas数据交换

https://mp.weixin.qq.com/s/-ZODFjsoW36BzD3cCgTQ3A

opcua数据读入到数据库

```python
from sqlalchemy import create_engine

# todo step1 定义数据库引擎
engine = create_engine('sqlite:///' + r'D:\02_Task\07_EdgeTech\11_SQL\opcua2sql.db')
cur_data_1s.to_sql('wind', engine, index=False, if_exists='append')
print(var_data)
```

数据读出 sql2pandas

```python
import pandas as pd
from sqlalchemy import create_engine

# step1 创建sql引擎
engine = create_engine('sqlite:///' + r'D:\02_Task\07_EdgeTech\11_SQL\opcua2sql.db')
# step2 写明查找内容
sql = 'select datetime,blade1_acc_xa from wind'
# step3 读取数据库数据
df = pd.read_sql_query(sql, engine)
print(df)
```

## 三. MySQL介绍

https://www.bilibili.com/video/BV1DJ411m73j?from=search&seid=48499941822714157

https://blog.csdn.net/weixin_44783814/article/details/106709165

1. 如果一个项目是动态(jsp,php,shtml)的，则数据库服务器是必不可少的环节。
2. 在web应用方面，MySQL是最好的RDBMS(关系型数据库管理系统)

### 一.安装mysql

https://www.cnblogs.com/zhou0000/p/8509100.html

1.检查Linux系统中是否已经安装了MySQL，命令为：

```
　sudo service mysql start
```

　若提示mysql：unrecognized service则说明系统中没有MySQL，需要继续安装。

2.Ubuntu Linux 安装配置MySQL：在Ubuntu上安装MySQL，最简单的方式是在线安装

```
　命令为：sudo apt-get install mysql-server    #安装MySQL服务端，核心程序

　　　　　　sudo apt-get install mysql-client　  #安装MySQL客户端
　　　　　　
　　　　　　sudo apt-get install libmysqlclient-dev
　　　　　　         
           sudo apt install net-tools   #Ubuntu 安装 net-tools，执行：
```

　　在安装过程中会提示输入确认YES，设置root用户密码（之后可以修改）等

　　安装结束后，验证是否安装成功命令：

```
sudo netstat -tap | grep mysql
```

3.安装成功后，可以根据自己的需求，用个gedit修改MySQL的配置文件（my.cnf）,命令为：

```
　　sudo gedit /etc/mysql/my.cnf
```

至此，Linux中MySQL已经安装，配置完成。

错误鸡精：

```
	ERROR 1524 (HY000) 
	解决： 重启数据库
	sudo /etc/init.d/mysql stop 
	sudo /etc/init.d/mysql start 
```



如果依然报错，那就卸载后重装；

### 二.运行mysql

1.打开MySQL

　　启动MySQL：　　

```
sudo service mysql start
```

　　使用root用户登录：

```
mysql -u root -p
```

​	**如果定义普通用户登录，需要赋权到组；**

2.其他操作命令见：http://www.cnblogs.com/zhou0000/p/8287520.html

PS：1. Windows和Linux中MySQL的基本操作命令大体没什么区别

　　2. 注意每条语句结尾要写分号;

### 三.创建用户组

登录MySQL

登录本地用户

```
mysql -u root -p
```

登录外网用户（需要注意服务器可能只允许本地登录，需要修改响应的配置文件）

```
mysql -u zheng -h 10.64.6.4 -p1
```

添加用户

1.允许本地访问的用户（127.0.0.1）

```
create user zheng@localhost identified by '123456';  
```

2.允许外网IP访问的用户

```
create user 'zheng'@'%' identified by '123456'; 
```

用户分配权限

授予用户在本地服务器对该数据库的全部权限

```
grant all privileges on wind to zheng@localhost identified by '123456';
```

授予用户通过外网IP对于该数据库的全部权限

```
grant all privileges on wind to 'zheng'@'%' identified by '123456';  
```

刷新权限

```
flush privileges;  
```



